name: Release Build

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install NSIS
        run: |
          choco install nsis -y
          # Add NSIS to PATH for current session
          $env:Path += ";C:\Program Files (x86)\NSIS"
          echo "C:\Program Files (x86)\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: pwsh

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Build CLI application
        run: |
          if (-not (Test-Path "build/bin")) {
            New-Item -ItemType Directory -Path "build/bin" | Out-Null
          }
          go build -tags cli -o build/bin/nstudio-cli-windows-amd64.exe .
        shell: pwsh

      - name: Prepare CLI for NSIS installer
        run: |
          # Copy CLI to installer directory so NSIS can include it
          Copy-Item -Path "build/bin/nstudio-cli-windows-amd64.exe" -Destination "build/windows/installer/nstudio-cli.exe"
        shell: pwsh

      - name: Build GUI application with NSIS installer
        run: wails build -clean -platform windows/amd64 -nsis

      - name: Prepare artifacts
        run: |
          # Copy engine dependencies for installer context
          Copy-Item -Path "build/windows/installer/engines" -Destination "build/bin/engines" -Recurse -Force
          # Restore CLI executable (removed by -clean flag during GUI build)
          Copy-Item -Path "build/windows/installer/nstudio-cli.exe" -Destination "build/bin/nstudio-cli-windows-amd64.exe"
        shell: pwsh

      - name: Upload Windows Installer
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          Write-Host "Listing all files in build/bin:"
          Get-ChildItem -Path "build/bin" -Recurse | ForEach-Object { Write-Host $_.FullName }

          $installer = Get-ChildItem -Path "build/bin" -Filter "*installer.exe" | Select-Object -First 1
          if ($installer) {
            Write-Host "Found installer: $($installer.FullName)"
            gh release upload ${{ github.event.release.tag_name }} $installer.FullName
          } else {
            Write-Host "ERROR: No installer.exe file found in build/bin"
            Write-Host "This may indicate the NSIS build failed or the installer has a different name pattern"
            exit 1
          }
        shell: pwsh

      - name: Upload Windows CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload ${{ github.event.release.tag_name }} build/bin/nstudio-cli-windows-amd64.exe
        shell: pwsh

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Build CLI application
        run: |
          mkdir -p build/bin
          go build -tags cli -o build/bin/nstudio-cli-darwin-universal .

      - name: Build GUI application
        run: wails build -clean -platform darwin/universal

      - name: Package macOS GUI
        run: |
          cd build/bin
          # Create a zip of the .app bundle if it exists
          if [ -d "Narration Studio.app" ]; then
            zip -r narration-studio-macos-universal.zip "Narration Studio.app"
          elif [ -f "narration_studio.app" ]; then
            zip -r narration-studio-macos-universal.zip "narration_studio.app"
          elif [ -f "Narration Studio" ]; then
            # If it's just an executable, zip it
            zip narration-studio-macos-universal.zip "Narration Studio"
          fi

      - name: Upload macOS GUI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd build/bin
          if [ -f narration-studio-macos-universal.zip ]; then
            gh release upload ${{ github.event.release.tag_name }} narration-studio-macos-universal.zip
          fi

      - name: Upload macOS CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload ${{ github.event.release.tag_name }} build/bin/nstudio-cli-darwin-universal

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgtk-3-dev libwebkit2gtk-4.1-dev libasound2-dev

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Build CLI application
        run: |
          mkdir -p build/bin
          go build -tags cli -o build/bin/nstudio-cli-linux-amd64 .

      - name: Build GUI application
        run: wails build -clean -platform linux/amd64

      - name: Create GUI .deb package
        run: |
          # Determine the GUI executable name
          if [ -f "build/bin/narration_studio" ]; then
            GUI_EXEC="narration_studio"
          elif [ -f "build/bin/Narration Studio" ]; then
            GUI_EXEC="Narration Studio"
          else
            echo "GUI executable not found"
            exit 1
          fi

          # Create package structure
          PKG_DIR="narration-studio-gui_${{ github.event.release.tag_name }}_amd64"
          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/usr/bin"
          mkdir -p "${PKG_DIR}/usr/share/applications"
          mkdir -p "${PKG_DIR}/usr/share/icons/hicolor/256x256/apps"
          mkdir -p "${PKG_DIR}/usr/share/doc/narration-studio"

          # Copy binary
          cp "build/bin/${GUI_EXEC}" "${PKG_DIR}/usr/bin/narration-studio"
          chmod 755 "${PKG_DIR}/usr/bin/narration-studio"

          # Copy icon
          cp build/appicon.png "${PKG_DIR}/usr/share/icons/hicolor/256x256/apps/narration-studio.png"

          # Create .desktop file
          cat > "${PKG_DIR}/usr/share/applications/narration-studio.desktop" << EOF
          [Desktop Entry]
          Name=Narration Studio
          Comment=Text-to-speech narration tool
          Exec=/usr/bin/narration-studio
          Icon=narration-studio
          Terminal=false
          Type=Application
          Categories=Audio;AudioVideo;
          EOF

          # Create control file
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: narration-studio
          Version: ${{ github.event.release.tag_name }}
          Section: sound
          Priority: optional
          Architecture: amd64
          Maintainer: phyce <contact@mechanic.ink>
          Description: Narration Studio - Text-to-speech application
           A powerful text-to-speech narration tool with support for
           multiple TTS engines including Piper and Microsoft SAPI.
          Homepage: https://narration.studio
          EOF

          # Build .deb
          dpkg-deb --build "${PKG_DIR}"
          mv "${PKG_DIR}.deb" "build/bin/narration-studio-gui_${{ github.event.release.tag_name }}_amd64.deb"

      - name: Create CLI .deb package
        run: |
          # Create package structure
          PKG_DIR="narration-studio-cli_${{ github.event.release.tag_name }}_amd64"
          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/usr/bin"
          mkdir -p "${PKG_DIR}/usr/share/doc/narration-studio-cli"

          # Copy binary
          cp build/bin/nstudio-cli-linux-amd64 "${PKG_DIR}/usr/bin/nstudio-cli"
          chmod 755 "${PKG_DIR}/usr/bin/nstudio-cli"

          # Create control file
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: narration-studio-cli
          Version: ${{ github.event.release.tag_name }}
          Section: sound
          Priority: optional
          Architecture: amd64
          Maintainer: phyce <contact@mechanic.ink>
          Description: Narration Studio CLI - Text-to-speech command-line tool
           Command-line interface for Narration Studio, a powerful text-to-speech
           narration tool with support for multiple TTS engines.
          Homepage: https://narration.studio
          EOF

          # Build .deb
          dpkg-deb --build "${PKG_DIR}"
          mv "${PKG_DIR}.deb" "build/bin/narration-studio-cli_${{ github.event.release.tag_name }}_amd64.deb"

      - name: Create tar.gz archives (alternative to .deb)
        run: |
          cd build/bin
          # GUI tar.gz
          if [ -f "narration_studio" ]; then
            tar -czf narration-studio-gui-linux-amd64.tar.gz narration_studio
          elif [ -f "Narration Studio" ]; then
            tar -czf narration-studio-gui-linux-amd64.tar.gz "Narration Studio"
          fi
          # CLI tar.gz
          tar -czf narration-studio-cli-linux-amd64.tar.gz nstudio-cli-linux-amd64

      - name: Upload GUI .deb package
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload ${{ github.event.release.tag_name }} build/bin/narration-studio-gui_${{ github.event.release.tag_name }}_amd64.deb

      - name: Upload CLI .deb package
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload ${{ github.event.release.tag_name }} build/bin/narration-studio-cli_${{ github.event.release.tag_name }}_amd64.deb

      - name: Upload GUI tar.gz
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd build/bin
          if [ -f narration-studio-gui-linux-amd64.tar.gz ]; then
            gh release upload ${{ github.event.release.tag_name }} narration-studio-gui-linux-amd64.tar.gz
          fi

      - name: Upload CLI tar.gz
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload ${{ github.event.release.tag_name }} build/bin/narration-studio-cli-linux-amd64.tar.gz
